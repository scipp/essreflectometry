
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Focused reflectometry data reduction &#8212; ESSreflectometry</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=721759c0"></script>
    <script src="../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user-guide/focused-reflectometry-data-reduction';</script>
    <script src="../_static/anaconda-icon.js?v=461bdc62"></script>
    <link rel="icon" href="../_static/favicon.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../api-reference/index.html" />
    <link rel="prev" title="Collimated data reduction for OFFSPEC" href="offspec/offspec_reduction.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="26.2.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="ESSreflectometry - Home"/>
    <img src="../_static/logo-dark.svg" class="logo__image only-dark pst-js-only" alt="ESSreflectometry - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    About
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/plopp">
    Plopp
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/sciline">
    Sciline
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/scippneutron">
    ScippNeutron
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/scippnexus">
    ScippNexus
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/essreflectometry" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/essreflectometry/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/essreflectometry" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/plopp">
    Plopp
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/sciline">
    Sciline
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/scippneutron">
    ScippNeutron
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/scippnexus">
    ScippNexus
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/essreflectometry" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/essreflectometry/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/essreflectometry" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="amor/index.html">Amor</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="amor/amor-reduction.html">Divergent data reduction for Amor</a></li>
<li class="toctree-l2"><a class="reference internal" href="amor/amor-reduction-advanced.html">Divergent data reduction for Amor - advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="amor/compare-to-eos.html">Comparison with PSI reduction software</a></li>
<li class="toctree-l2"><a class="reference internal" href="amor/workflow-widget.html">Workflow widget</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="estia/index.html">ESTIA</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="estia/estia-mcstas-reduction.html">Reduction of ESTIA McStas data</a></li>
<li class="toctree-l2"><a class="reference internal" href="estia/estia-advanced-mcstas-reduction.html">ESTIA advanced data reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="estia/simulated-spin-flip-sample.html">Reduction of spin flip data from McStas simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="estia/create-estia-tof-lookup-table.html">Create a TOF lookup table for ESTIA</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="offspec/index.html">Offspec</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="offspec/offspec_reduction.html">Collimated data reduction for OFFSPEC</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Focused reflectometry data reduction</a></li>
</ul>
</div>
</nav></div>
        <div class="sidebar-primary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#target-audience">Target audience</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preliminaries">Preliminaries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-of-event-intensity-in-the-detector">Model of event intensity in the detector</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-r-q">Estimating <span class="math notranslate nohighlight">\(R(Q)\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-reference-intensity-i-text-ideal">The reference intensity <span class="math notranslate nohighlight">\(I_{\text{ideal}}\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-intensities-from-detector-counts">Estimating intensities from detector counts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-efficient-evaluation-of-the-reference-intensity">More efficient evaluation of the reference intensity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-reference-intensity-for-the-amor-instrument">Evaluating the reference intensity for the Amor instrument</a></li>
</ul>
</li>
</ul>
  </nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/user-guide/focused-reflectometry-data-reduction.md"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Focused reflectometry data reduction</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="focused-reflectometry-data-reduction">
<h1>Focused reflectometry data reduction<a class="headerlink" href="#focused-reflectometry-data-reduction" title="Link to this heading">#</a></h1>
<p>The goal of the reflectometry data reduction is to compute the reflectivity <span class="math notranslate nohighlight">\(R(Q)\)</span> of the sample as a function of the momentum transfer <span class="math notranslate nohighlight">\(Q\)</span>.</p>
<p>Based on <span id="id1">[<a class="reference internal" href="../about/bibliography.html#id2" title="J. Stahn and A. Glavic. Focusing neutron reflectometry: implementation and experience on the tof-reflectometer amor. Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment, 821:44-54, 2016. doi:https://doi.org/10.1016/j.nima.2016.03.007.">SG16</a>]</span>.</p>
<section id="target-audience">
<h2>Target audience<a class="headerlink" href="#target-audience" title="Link to this heading">#</a></h2>
<p>The target audience of this text is anyone who wants to know the reasoning behind the data reduction workflow implemented for the focusing reflectometry instruments ESTIA at ESS and AMOR at PSI.
It is not necessary to read this to be able to use the workflow, for that we recommend the tutorial notebooks as they will give a much more practically useful introduction, but if you are going to develop new features it is probably good to at least skim it.</p>
</section>
<section id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Link to this heading">#</a></h2>
<p>The detector data is a list <span class="math notranslate nohighlight">\(EV\)</span> of detected neutron events.
For each event in the list we know its wavelength <span class="math notranslate nohighlight">\(\lambda\)</span> and the pixel number <span class="math notranslate nohighlight">\(j\)</span> of the detector pixel that it hit.
The detector pixel positions are known and so is the position and the orientation of the sample.
From this information we can compute the reflection angle <span class="math notranslate nohighlight">\(\theta\)</span>, and the momentum transfer <span class="math notranslate nohighlight">\(Q\)</span> caused by the interaction with the sample.</p>
<p>The purpose of this text is not to describe how the event coordinates wavelength, <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(\theta\)</span> are derived from the raw detector data and the instrument geometry, so for now just take those for given.
For more details see the implementations for the respective instruments [Amor] and [Estia].</p>
<p>To simplify the description it is assumed that the sample- and reference measurements were made over the same length of time, and it is assumed the brightness of the source did not change between the measurements.</p>
</section>
<section id="model-of-event-intensity-in-the-detector">
<h2>Model of event intensity in the detector<a class="headerlink" href="#model-of-event-intensity-in-the-detector" title="Link to this heading">#</a></h2>
<p>The reflectivity of the sample is related to the intensity of neutron counts in the detector by the model</p>
<div class="math notranslate nohighlight" id="equation-model">
<span class="eqno">(1)<a class="headerlink" href="#equation-model" title="Link to this equation">#</a></span>\[
I_{\text{sam}}(\lambda, j) = F(\theta(\lambda, j, \mu_{\text{sam}}), w_{\text{sam}}) \cdot R(Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}}))) \cdot I_{\text{ideal}}(\lambda, j)
\]</div>
<p>where <span class="math notranslate nohighlight">\(I_{\text{sam}}(\lambda, j)\)</span> represents the expected number of neutrons detected in the <span class="math notranslate nohighlight">\(j\)</span> pixel of the detector per unit of wavelength at the wavelength value <span class="math notranslate nohighlight">\(\lambda\)</span>. <span class="math notranslate nohighlight">\(I_{\text{ideal}}\)</span> represents the expected number of neutrons detected if the sample was a perfect reflector and large enough so that the footprint of the focused beam on the sample was small compared to the sample. <span class="math notranslate nohighlight">\(F(\theta, w)\)</span> is the fraction of the beam that hits the sample. It depends on the incidence angle <span class="math notranslate nohighlight">\(\theta\)</span> and on the size of the sample represented by <span class="math notranslate nohighlight">\(w,\)</span> and <span class="math notranslate nohighlight">\(\mu_{\text{sam}}\)</span> is the sample rotation.</p>
<p>The model does not hold for any <span class="math notranslate nohighlight">\(\lambda,j\)</span>. For example, there might be a region in the detector where we can see part of the direct beam. To make this explicit, let <span class="math notranslate nohighlight">\(M_{sam}\)</span> represent the region of <span class="math notranslate nohighlight">\(\lambda,j\)</span>  where the model is expected to hold (the “region of interest”).</p>
<p>The ideal intensity <span class="math notranslate nohighlight">\(I_{ideal}\)</span> will be estimated from a reference measurement on a neutron supermirror.
How that is done will be described in more detail later, for now assume it is a known quantity.</p>
</section>
<section id="estimating-r-q">
<h2>Estimating <span class="math notranslate nohighlight">\(R(Q)\)</span><a class="headerlink" href="#estimating-r-q" title="Link to this heading">#</a></h2>
<p>Move <span class="math notranslate nohighlight">\(F\)</span> to the left-hand-side of equation <a class="reference internal" href="#equation-model">(1)</a> and integrate over all <span class="math notranslate nohighlight">\(\lambda, j\in M\)</span> contributing to the <span class="math notranslate nohighlight">\(Q\)</span>-bin <span class="math notranslate nohighlight">\([q_{i}, q_{i+1}]\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}
\int_{M \cap Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]} \frac{I_{\text{sam}}(\lambda, j)}{F(\theta(\lambda, j, \mu_{\text{sam}}), w_{\text{sam}})} d\lambda \ dj = \\
\int_{M \cap Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]}  I_{\text{ideal}}(\lambda, j) R(Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}}))) d\lambda  \ dj.
\end{split}\]</div>
<p>Notice that if the <span class="math notranslate nohighlight">\(Q\)</span> binning is sufficiently fine then <span class="math notranslate nohighlight">\(R(Q)\)</span> is approximately constant in the integration region.
Assuming the binning is fine enough <span class="math notranslate nohighlight">\(R(Q)\)</span> can be moved outside the integral and isolated so that</p>
<div class="math notranslate nohighlight" id="equation-reflectivity">
<span class="eqno">(2)<a class="headerlink" href="#equation-reflectivity" title="Link to this equation">#</a></span>\[
 R(Q_{i+\frac{1}{2}}) \approx \frac{\int_{M \cap Q(\lambda, j, \mu_{\text{sam}}) \in [q_{i}, q_{i+1}]} \frac{I_{\text{sam}}(\lambda, j)}{F(\theta(\lambda, j, \mu_{\text{sam}}), w_{\text{sam}})} d\lambda \ dj }{\int_{M \cap Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]}  I_{\text{ideal}}(\lambda, j) d\lambda  \ dj} =: \frac{I_{measured}(Q_{i+\frac{1}{2}})}{I_{\text{ideal}}(Q_{i+\frac{1}{2}})}
\]</div>
<p>for <span class="math notranslate nohighlight">\(Q_{i+\frac{1}{2}} \in [q_{i}, q_{i+1}]\)</span>.</p>
<p>For the integral to make sense the region of interest <span class="math notranslate nohighlight">\(M\)</span> has to be contained in the region where <a class="reference internal" href="#equation-model">(1)</a> holds, <span class="math notranslate nohighlight">\(M\subset M_{sam}\)</span>, but there might be other constraints limiting the region of interest <span class="math notranslate nohighlight">\(M\)</span> even more, so it is left undefined for now.</p>
</section>
<section id="the-reference-intensity-i-text-ideal">
<h2>The reference intensity <span class="math notranslate nohighlight">\(I_{\text{ideal}}\)</span><a class="headerlink" href="#the-reference-intensity-i-text-ideal" title="Link to this heading">#</a></h2>
<p><span class="math notranslate nohighlight">\(I_{\text{ideal}}\)</span> is estimated from a reference measurement on a neutron supermirror with known reflectivity curve.
The reference measurement intensity <span class="math notranslate nohighlight">\(I_{\text{ref}}\)</span> is modeled the same way the sample measurement was</p>
<div class="math notranslate nohighlight">
\[
I_{\text{ref}}(\lambda, j) = F(\theta(\lambda, j, \mu_{\text{ref}}), w_{\text{ref}}) \cdot R_{\text{supermirror}}(Q(\lambda, \theta(\lambda, j, \mu_{\text{ref}}))) \cdot I_{\text{ideal}}(\lambda, j)
\]</div>
<p>but in this case <span class="math notranslate nohighlight">\(R_{\text{supermirror}}(Q)\)</span> is known.</p>
<p>As before, the model does not hold for any <span class="math notranslate nohighlight">\(\lambda,j\)</span>. Let <span class="math notranslate nohighlight">\(M_{ref}\)</span> represent the region of <span class="math notranslate nohighlight">\(\lambda,j\)</span>  where the model is expected to hold. <span class="math notranslate nohighlight">\(M_{ref}\)</span> is typically not the same as <span class="math notranslate nohighlight">\(M_{sam}\)</span>. For example, if the supermirror reflectivity is not known for all <span class="math notranslate nohighlight">\(Q\)</span> we are not going to have a model for the reference intensity at the <span class="math notranslate nohighlight">\(\lambda,j\)</span> corresponding to those <span class="math notranslate nohighlight">\(Q\)</span> and that is reflected in <span class="math notranslate nohighlight">\(M_{ref}\)</span> but not in <span class="math notranslate nohighlight">\(M_{sam}\)</span>.</p>
<p>Using the definition in <a class="reference internal" href="#equation-reflectivity">(2)</a></p>
<div class="math notranslate nohighlight">
\[
I_{\text{ideal}}(Q_{i+\frac{1}{2}}) = \int_{M \cap Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]} \frac{I_{\text{ref}}(\lambda, j)}{F(\theta(\lambda, j, \mu_{\text{ref}}), w_{\text{ref}}) R_{\text{supermirror}}(Q(\lambda, \theta(\lambda, j, \mu_{\text{ref}})))}
 d\lambda  \ dj.
\]</div>
<p>For this integral to make sense <span class="math notranslate nohighlight">\(M\subset M_{ref}\)</span>, so now we have an additional constraint on <span class="math notranslate nohighlight">\(M\)</span> to keep in mind.</p>
</section>
<section id="estimating-intensities-from-detector-counts">
<h2>Estimating intensities from detector counts<a class="headerlink" href="#estimating-intensities-from-detector-counts" title="Link to this heading">#</a></h2>
<p>The number of neutron counts in the detector is a Poisson process where the expected number of neutrons per pixel and unit of wavelength are the measurement intensities <span class="math notranslate nohighlight">\(I_{sam}\)</span> and <span class="math notranslate nohighlight">\(I_{ref}\)</span> defined above.
The expected intensity can be estimated by the measured intensity:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
I_{measured}(Q_{i+\frac{1}{2}}) = \int_{M\cap Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]} \frac{I_{\text{sam}}(\lambda, j)}{F(\theta(\lambda, j, \mu_{\text{sam}}), w_{\text{sam}})} d\lambda \ dj \\
 \approx \sum_{\substack{k \in EV_{\text{sam}} \\ Q(\lambda_{k}, \theta(\lambda_{k}, j_{k}, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]\\ (\lambda_k, j_k)\in M}} \frac{1}{F(\theta(\lambda_{k}, j_{k}, \mu_{\text{sam}}), w_{\text{sam}})}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(EV_{\text{sam}}\)</span> refers to the event list from the sample experiment.</p>
<p>The sum is compound Poisson distributed and for such random variables the variance can be estimated by the sum of squared summands</p>
<div class="math notranslate nohighlight">
\[\begin{split}
V\bigg[ \sum_{\substack{k \in EV_{\text{sam}} \\ Q(\lambda_{k}, \theta(\lambda_{k}, j_{k}, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]\\ (\lambda_k, j_k)\in M}} \frac{1}{F(\theta(\lambda_{k}, j_{k}, \mu_{\text{sam}}), w_{\text{sam}})} \bigg] \approx
\sum_{\substack{k \in EV_{\text{sam}} \\ Q(\lambda_{k}, \theta(\lambda_{k}, j_{k}, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]\\ (\lambda_k, j_k)\in M}} \frac{1}{F(\theta(\lambda_{k}, j_{k}, \mu_{\text{sam}}), w_{\text{sam}})^2}.
\end{split}\]</div>
<p>The same estimates are used to approximate the ideal intensity:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
I_{\text{ideal}}(Q_{i+\frac{1}{2}}) \approx \sum_{\substack{k \in EV_{\text{ref}} \\ Q(\lambda_{k}, \theta(\lambda_{k}, j_{k}, \mu_{\text{sam}})) \in [q_{i}, q_{i+1}]\\ (\lambda_k, j_k)\in M}} \frac{1}{F(\theta(\lambda_{k}, j_{k}, \mu_{\text{ref}}), w_{\text{ref}}) R_{\text{supermirror}}(Q(\lambda_{k}, \theta(\lambda_{k}, j_{k}, \mu_{\text{ref}})))}
\end{split}\]</div>
<p>The above expressions and <a class="reference internal" href="#equation-reflectivity">(2)</a> lets us express <span class="math notranslate nohighlight">\(R(Q_{i+{\frac{1}{2}}})\)</span> and its uncertainty in terms of the neutron counts in the detector.</p>
</section>
<section id="more-efficient-evaluation-of-the-reference-intensity">
<h2>More efficient evaluation of the reference intensity<a class="headerlink" href="#more-efficient-evaluation-of-the-reference-intensity" title="Link to this heading">#</a></h2>
<p>The above expression for the reference intensity is cumbersome to compute because it is a sum over the reference measurement event list, and the reference measurement is large compared to the sample measurement.</p>
<p>Therefore we back up a bit. Consider the expression for the reference intensity, replacing the integrand with a generic <span class="math notranslate nohighlight">\(I(\lambda, j)\)</span> it looks something like:</p>
<div class="math notranslate nohighlight">
\[
I_{\text{ideal}}(Q_{i+\frac{1}{2}}) = \int_{Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}}))  \in [q_{i}, q_{i+1}]} I(\lambda, j) \ d\lambda  \ dj.
\]</div>
<p>In the previous section we approximated the integral by summing over all events in the reference measurement.</p>
<p>Alternatively, we could define a <span class="math notranslate nohighlight">\(\lambda\)</span> grid with edges <span class="math notranslate nohighlight">\(\lambda_{k}\)</span> for <span class="math notranslate nohighlight">\(k=1\ldots N\)</span> and approximate the integration region as the union of a subset of the grid cells:</p>
<div class="math notranslate nohighlight">
\[
\int_{Q(\lambda, \theta(\lambda, j, \mu_{\text{sam}}))  \in [q_{i}, q_{i+1}]} I(\lambda, j) \ d\lambda  \ dj
\approx \sum_{Q(\bar{\lambda}_{k+\frac{1}{2}},\ \theta(\bar{\lambda}_{k+\frac{1}{2}}, j, \mu_{\text{sam}}))  \in [q_{i}, q_{i+1}]} I_{k+\frac{1}{2},j}
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
I_{k+\frac{1}{2},j} = \int_{\lambda \in [\lambda_{k}, \lambda_{k+1}]} I(\lambda, j) \ d\lambda
\]</div>
<p>and <span class="math notranslate nohighlight">\(\bar{\lambda}_{k+\frac{1}{2}} = (\lambda_{k} + \lambda_{k+1}) / 2\)</span>.</p>
<p>Why would this be more efficient than the original approach? Note that <span class="math notranslate nohighlight">\(I_{k+\frac{1}{2}, j}\)</span> does not depend on <span class="math notranslate nohighlight">\(\mu_{\text{sam}}\)</span>, and that it can be computed once and reused for all sample measurements.
This allows us to save computing time for each new sample measurement, as long as <span class="math notranslate nohighlight">\(|EV_{\text{ref}}| &gt;&gt; NM\)</span> where <span class="math notranslate nohighlight">\(M\)</span> is the number of detector pixels and <span class="math notranslate nohighlight">\(N\)</span> is the size of the <span class="math notranslate nohighlight">\(\lambda\)</span> grid.</p>
<p>However, ideally computing the reference intensity should be quick compared to reducing the sample measurement. And since a reasonable value for <span class="math notranslate nohighlight">\(N\)</span> is approximately <span class="math notranslate nohighlight">\(500\)</span>, and <span class="math notranslate nohighlight">\(M\approx 30000\)</span>, and a sample measurement is likely less than <span class="math notranslate nohighlight">\(10\)</span> million events, the cost of computing the reference measurement is still considerable compared to reducing the sample measurement.</p>
<p>Therefore there’s one more approximation that is used to further reduce the cost of computing the reference intensity.
The description of the final approximation is instrument specific.
In the next section it is described specifically for the Amor instrument.</p>
<section id="evaluating-the-reference-intensity-for-the-amor-instrument">
<h3>Evaluating the reference intensity for the Amor instrument<a class="headerlink" href="#evaluating-the-reference-intensity-for-the-amor-instrument" title="Link to this heading">#</a></h3>
<p>The Amor detector has three logical dimensions, <code class="docutils literal notranslate"><span class="pre">blade</span></code>, <code class="docutils literal notranslate"><span class="pre">wire</span></code> and <code class="docutils literal notranslate"><span class="pre">strip</span></code>. It happens to be the case that <span class="math notranslate nohighlight">\(\theta(\lambda, j)\)</span> is almost the same for all <span class="math notranslate nohighlight">\(j\)</span> belonging to the same <code class="docutils literal notranslate"><span class="pre">strip</span></code> of the detector.
We can express this as</p>
<div class="math notranslate nohighlight">
\[
\theta(\lambda, j, \mu_{\text{sam}}) \approx \bar{\theta}(\lambda, \mathrm{bladewire}(j), \mu_{\text{sam}})
\]</div>
<p>where <span class="math notranslate nohighlight">\(\bar{\theta}\)</span> is an approximation for <span class="math notranslate nohighlight">\(\theta\)</span> that only depends on the blade and the wire of the pixel where the neutron was detected.
Then the above expression for the reference intensity can be rewritten as</p>
<div class="math notranslate nohighlight">
\[
\int_{Q(\lambda, \bar{\theta}(\lambda, z, \mu_{\text{sam}}))  \in [q_{i}, q_{i+1}]} \int_{\mathrm{bladewire}(j) = z} I(\lambda, j) \ dj \ d\lambda  \ dz
\approx \sum_{Q(\bar{\lambda}_{k+\frac{1}{2}}, \bar{\theta}(\bar{\lambda}_{k+\frac{1}{2}}, z, \mu_{\text{sam}}))  \in [q_{i}, q_{i+1}]} I_{k+\frac{1}{2},z}
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
I_{k+\frac{1}{2},z} = \int_{\lambda \in [\lambda_{k}, \lambda_{k+1}]} \int_{\mathrm{bladewire}(j) = z} I(\lambda, j) \ dj \ d\lambda .
\]</div>
<p>Like before, the benefit of doing this is that</p>
<div class="math notranslate nohighlight">
\[
 \int_{\lambda \in [\lambda_{k}, \lambda_{k+1}]} \int_{\mathrm{bladewire}(j) = z} I(\lambda, j) \ dj \ d\lambda
\]</div>
<p>can be pre-computed because it doesn’t depend on <span class="math notranslate nohighlight">\(\mu_{\text{sam}}\)</span>.
But unlike before <span class="math notranslate nohighlight">\(I_{k+\frac{1}{2},z}\)</span> now has a much more manageable size, about 64x smaller than the first attempt.
This makes it comfortably smaller than the sample measurement.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="offspec/offspec_reduction.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Collimated data reduction for OFFSPEC</p>
      </div>
    </a>
    <a class="right-next"
       href="../api-reference/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API Reference</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025 Scipp contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.0.4.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
Current ESSreflectometry version: 26.2.0 (<a href="https://github.com/scipp/essreflectometry/releases">older versions</a>).</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>